"use strict";var pieChart=angular.module("cloudTag",[]);pieChart.factory("d3",function(){return d3}),pieChart.directive("cloudTag",["$routeParams","d3","globalData","sparqlQuery",function(t,e,n,a){function r(t,e){var r=t;a.querySrv({query:r},function(t){jsonld.compact(t,n.CONTEXT,function(t,n){if(n){var a=n["@graph"];if(a){var r=$("div.tree-node-author-info ."+e);r.html("");var u=a.length?a:[a];r.append('<h4 style="padding: 20px" class="totalauthors text-success"> Autores: '+(u.length-1)+"</h4>");var i=$("<div>");r.append(i),_.map(u,function(t){if(t["rdfs:label"]&&t["uc:total"]["@value"]){var e=$("<a class='relatedauthors' target='blank' onclick = 'clickonRelatedauthor(\""+t["@id"]+"\")'  >").text("");return e.append(t["rdfs:label"]+"("+t["uc:total"]["@value"]+")"),i.append(e),i.append("</br>"),e}})}waitingDialog.hide()}waitingDialog.hide()})})}function u(t){var e=t.label;if(e){var n=String.format(q,e,e);r(n,"authorsByPublications")}}var i,c,l,o,s,b,d,f,p,h,v,g,m,y,x,E,T,R,w,I,C,k,U,A,j,P,S,N,O,D,L,H,q=(n.PREFIX+' CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}"  .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {  SELECT DISTINCT  ?subject ?name (count(?pub) as ?totalPub) WHERE {    GRAPH <'+n.clustersGraph+">          {                  ?cluster <http://ucuenca.edu.ec/resource/hasPerson> <{1}> .                 ?cluster <http://ucuenca.edu.ec/resource/hasPerson> ?subject.                 ?subject foaf:publications ?pub                 {                     SELECT ?name                     {                         graph <"+n.centralGraph+">                         {                             ?subject foaf:name ?name.                         }                     }             }         }      } group by ?subject ?name           }}    ",n.PREFIX+'  CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}" .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {      SELECT ?subject (count(DISTINCT(?publicationUri)) as ?totalPub) ?name          WHERE {              GRAPH <'+n.centralGraph+'> {              ?subject foaf:publications ?publicationUri.              ?publicationUri bibo:Quote ?quote .             FILTER (mm:fulltext-search(?quote, "{1}" )) .             ?subject foaf:name ?name.  }              }          GROUP BY ?subject ?name   }  } LIMIT 100');d=[],I=null,y=null,x={top:5,right:0,bottom:0,left:0},E=55,C=e.scale.sqrt().range([0,E]),k=function(t){return parseInt(t.value)},g=function(t){return t.label},U=function(t){return t.label},s=10,T=3,m=.01,j=function(t){return t.forEach(function(t){t.value=parseInt(t.value)}),t},A=function(t){var e;return e=.01*t.alpha,I.each(p(e)).each(o(m)).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}),y.style("left",function(t){return 17+(x.left+t.x)-t.dx/2+"px"}).style("top",function(t){return 50+(x.top+t.y)-t.dy/2+"px"})},i=function(t){return t.each(function(t){var n,a,r;return d=j(t),n=e.max(d,function(t){return k(t)}),C.domain([0,n]),a=e.select(this).selectAll("svg").data([d]),r=a.enter().append("svg"),a.attr("width",D+x.left+x.right),a.attr("height",v+x.top+x.bottom),I=r.append("g").attr("id","bubble-nodes").attr("transform","translate("+x.left+","+x.top+")"),I.append("rect").attr("id","bubble-background").attr("width",D).attr("height",v).on("click",c),y=e.select(this).selectAll("#bubble-labels").data([d]).enter().append("div").attr("id","bubble-labels"),P(),e.select(window)})},P=function(){return d.forEach(function(t,e){return t.forceR=Math.max(T,C(k(t)))}),f.nodes(d).start(),O(),N()},O=function(){return I=I.selectAll(".bubble-node").data(d,function(t){return g(t)}),I.exit().remove(),I.enter().append("a").attr("class","bubble-node").attr("xlink:href",function(t){return"#"+encodeURIComponent(g(t))}).call(f.drag).call(b).append("circle").attr("id","kcircle").attr("r",function(t){return C(k(t))})},N=function(){var t;return y=y.selectAll(".bubble-label").data(d,function(t){return g(t)}),y.exit().remove(),t=y.enter().append("a").attr("class","bubble-label"),t.append("div").attr("class","bubble-label-name").text(function(t){return U(t)}).call(b),t.append("div").attr("class","bubble-label-value").text(function(t){return k(t)}),y.style("font-size",function(t){return Math.max(9,C(k(t)/5))+"px"}).style("width",function(t){return.1*C(k(t))+"px"}),y.append("span").text(function(t){return U(t)}).each(function(t){return t.dx=Math.max(2.5*C(k(t)),this.getBoundingClientRect().width)}).remove(),y.style("width",function(t){return t.dx+"px"}),y.each(function(t){return t.dy=(Number(this.getBoundingClientRect().height)-110).toString()})},p=function(t){var e,n,a,r;return a=D/2,r=v/2,e=t/8,n=t,function(t){return t.x+=(a-t.x)*e,t.y+=(r-t.y)*n}},o=function(t){return function(e){return d.forEach(function(n){var a,r,u,i,c,l;if(e!==n&&(c=e.x-n.x,l=e.y-n.y,a=Math.sqrt(c*c+l*l),r=e.forceR+n.forceR+s,a<r))return a=(a-r)/a*t,u=c*a,i=l*a,e.x-=u,e.y-=i,n.x+=u,n.y+=i})}},b=function(t){return t.on("click",l),t.on("mouseover",w),t.on("mouseout",R)},c=function(){return location.replace("#")},l=function(r){u(r);var i=$("div.tree-node-info");if(i){var c=r.label,l=$("div.head-info");l.find("title").text("ddddddtitletitle"),l.html("");var o,s=$("<div>");o="es"===t.lang?$('<span class="label label-primary" style="font-size:35px; background-color: #003769; opacity: 0.8;">').text("PUBLICACIONES Y AUTORES RELACIONADOS CON: "+c):$('<span class="label label-primary" style="font-size:35px; background-color: #003769; opacity: 0.8;">').text("PUBLICATIONS AND AUTHORS RELATED WITH: "+c),s.append(o),s.append("</br>"),l.append(s);var b=n.PREFIX+" CONSTRUCT { ?keyword uc:publication ?publicationUri.  ?publicationUri dct:contributors ?subject .  ?subject foaf:name ?name .  ?subject a foaf:Person .  ?publicationUri a bibo:Document.  ?publicationUri dct:title ?title.  ?publicationUri bibo:abstract ?abstract.  ?publicationUri bibo:uri ?uri.  }  WHERE { GRAPH <"+n.centralGraph+'> { ?subject foaf:publications ?publicationUri . ?subject foaf:name ?name . ?publicationUri dct:title ?title .  OPTIONAL{ ?publicationUri bibo:abstract  ?abstract. }  OPTIONAL{ ?publicationUri bibo:uri  ?uri. }  ?publicationUri bibo:Quote ?quote.  FILTER (mm:fulltext-search(?quote, "'+c+'" )) .  BIND(REPLACE( "'+c+'", " ", "_", "i") AS ?key) .  BIND(IRI(?key) as ?keyword) }}';waitingDialog.show("Searching publications with the keyword: "+c),a.querySrv({query:b},function(t){jsonld.compact(t,n.CONTEXT,function(t,e){if(e){var n=e["@graph"],a=n;a.length?a:[a];L.ctrlFn({value:n}),waitingDialog.hide()}else waitingDialog.hide()})})}return e.event.preventDefault()},h=function(){var t;return t=decodeURIComponent(location.hash.substring(1)).trim(),S(t)},S=function(t){return I.classed("bubble-selected",function(e){return t===g(e)}),t.length>0?e.select("#status").html('<h3>The word <span class="active">'+t+"</span> is now active</h3>"):e.select("#status").html("<h3>No word is active</h3>")},w=function(t){return I.classed("bubble-hover",function(e){return e===t})},R=function(t){return I.classed("bubble-hover",!1)},i.jitter=function(t){return arguments.length?(m=t,f.start(),i):m},i.height=function(t){return arguments.length?(v=t,i):v},i.width=function(t){return arguments.length?(D=t,i):D},i.r=function(t){return arguments.length?(k=t,i):k};var W=function(t,n,a,r,u,c){var l=t;l.html(""),D=n,v=a,L=u,H=c,f=e.layout.force().gravity(0).charge(0).size([D,v]).on("tick",A),t.datum(r).call(i)};return{restrict:"E",scope:{ctrlFn:"&",data:"="},compile:function(t,n,a){var r=parseInt(t.css("width")),u=parseInt(t.css("height")),i=n.ctWidth?n.ctWidth:r,c=n.ctHeight?n.ctHeight:u,l=e.select(t[0]);return function(t,e,n){t.$watch("data",function(t,e,a){var r=a.data;if(r){var u=r.data,o=r.schema,s=o.fields,b=[];_.each(u["@graph"],function(t,e){b.push({label:t[s[0]],value:t[s[1]]["@value"]})}),W(l,i,c,b,a,n)}},!0)}}}}]);