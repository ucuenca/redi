"use strict";var cloudGroup=angular.module("mapView",[]);cloudGroup.factory("d3",function(){return d3}),cloudGroup.directive("mapView",["d3","globalData","sparqlQuery",function(t,e,a){function n(n,r,c){function l(){var e=v[0]*t.event.scale+t.event.translate[0],a=v[1]*t.event.scale+t.event.translate[1];h.translate([e,a]),h.scale(f*t.event.scale),E.selectAll("path").attr("d",p),k.selectAll("circle").attr("cx",function(e,a){return v[0]+t.event.translate[0]+g[a][0]*t.event.scale-6400}).attr("cy",function(e,a){return v[1]+t.event.translate[1]+g[a][1]*t.event.scale-110}),x.attr("x1",e).attr("x2",e),w.attr("y1",a).attr("y2",a)}function s(n){var r=T.selectAll("g").data(n).enter().append("svg:g");k.selectAll("circle").on("mouseover",function(e,a){t.select("h3.tag").text(e.keyword),t.select("h3.name").text(e.name),t.select("h3.fullname").text(e.fullname),t.select("h3.city").text(e.city),t.select("h3.province").text(e.province),t.select("h3.total").text(e.total),t.select("h3.latitude").text(e.latitude),t.select("h3.longitude").text(e.longitude),t.select(this).transition().duration(750).attr("r",Math.sqrt(2*e.total)+16),m.html("<h2>"+e.keyword+"</h2> <br>  <h3>"+e.name+"</h3> <br>Click to See Authors Within This Research Area"),m.show(e)}).on("mouseout",function(e,a){t.select(this).transition().duration(750).attr("r",Math.sqrt(10*e.total)),m.hide(e)}).on("click",function(t,n){var r=e.PREFIX+' CONSTRUCT { <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors from '+t.name+" , taking place in "+t.keyword+' field" . ?subject rdfs:label ?name. ?subject uc:total ?totalPub }    WHERE {       SELECT ?subject ?totalPub ?name      WHERE {          ?subject foaf:publications ?pubb.          ?pubb bibo:Quote ?key.          FILTER (mm:fulltext-search(?key,"'+t.keyword+'")).          {          SELECT ?subject ?name (COUNT( DISTINCT ?pub) AS ?totalPub)               WHERE {                  GRAPH <'+e.centralGraph+">  {                      ?subject foaf:publications  ?pub .                      ?subject foaf:name       ?name.                             ?subject dct:provenance ?provenance.                      {                           SELECT * WHERE {                              GRAPH <"+e.endpointsGraph+'>  {                                  ?provenance uc:name ?sourcename.                                  FILTER(mm:fulltext-search(?sourcename,"'+t.name+'"))                             }                          }                      }                  }              }           GROUP BY ?subject ?name          }      } }  ';waitingDialog.show("Loading Authors Related with "+t.keyword),a.querySrv({query:r},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var a=e["@graph"];a.length?a:[a];c.ifClick({value:e}),waitingDialog.hide()}else waitingDialog.hide()})})}),r.append("svg:path").attr("class","cell").attr("d",function(t,e){}).on("mouseover",function(e,a){t.select("h3.name").text(e.name)})}var i=r;i.html("");var o=n,u=500,d=600,h=t.geo.mercator().scale(28500).translate([6400,110]),p=t.geo.path().projection(h),v=h.translate(),f=h.scale(),g=[];o=o.filter(function(t){var e=[+t.longitude,+t.latitude];return g.push(h(e)),!0});var m=t.tip().attr("class","tree-d3-tip").html(function(t){return" "}),b=r.append("svg:svg").attr("width",u).attr("height",d).call(t.behavior.zoom().on("zoom",l)),y=b.append("svg:g").attr("id","axes"),x=y.append("svg:line").attr("x1",v[0]).attr("y1",0).attr("x2",v[0]).attr("y2",d),w=y.append("svg:line").attr("x1",0).attr("y1",v[1]).attr("x2",u).attr("y2",v[1]),E=b.append("svg:g").attr("id","states"),k=b.append("svg:g").attr("id","circles");k.selectAll("circle").data(o).enter().append("svg:circle").call(o?m:function(){}).attr("cx",function(t,e){return g[e][0]}).attr("cy",function(t,e){return g[e][1]}).attr("r",function(t,e){return Math.sqrt(10*t.total)});var T=b.append("svg:g").attr("id","cells");t.select("input[type=checkbox]").on("change",function(){T.classed("voronoi",this.checked)}),t.json("../resources/ec-states.geojson",function(t){E.selectAll("path").data(t.features).enter().append("svg:path").attr("d",p)}),s(n)}return{restrict:"E",scope:{data:"=",ifClick:"&"},compile:function(e,a,r){var c=t.select(e[0]),l=parseInt(e.css("width")),s=parseInt(e.css("height"));a.ctWidth?a.ctWidth:l,a.ctHeight?a.ctHeight:s;return function(t,e,a){t.$watch("data",function(t,e,a){a.data&&a.data[0]&&n(a.data,c,a)},!0)}}}}]);