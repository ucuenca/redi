"use strict";var explorableTree=angular.module("explorableTree",[]);explorableTree.factory("d3",function(){return d3}),explorableTree.directive("explorableTree",["d3","globalData","sparqlQuery","authorRestQuery","$window",function(t,e,a,r,n){function i(t){return!!/^([0-9])*$/.test(t)}var o=e.PREFIX+'CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}"  .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   } WHERE {  {    SELECT ?subject ?name (COUNT(DISTINCT ?relpublication) as ?totalPub)    WHERE {        GRAPH <'+e.clustersGraph+"> {          ?cluster foaf:publications ?publication .          ?publication uc:hasPerson <{1}> .          ?cluster foaf:publications ?relpublication .          ?relpublication uc:hasPerson ?subject .          {            SELECT ?name {              GRAPH <"+e.centralGraph+"> {                 ?subject foaf:name ?name .              }            }          }          FILTER (?subject != <{1}>)        }    }    GROUP BY ?subject ?name    ORDER BY DESC(?totalPub)  }}",l=e.PREFIX+'  CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}" .         ?subject rdfs:label ?name.         ?subject uc:total ?totalPub   }   WHERE {   {      SELECT ?subject (count(?pub) as ?totalPub) ?name          WHERE {              GRAPH <'+e.centralGraph+"> {              <{1}> foaf:publications ?pub.              ?subject foaf:publications ?pub.             ?subject foaf:name ?name.  }              }          GROUP BY ?subject ?name   }  }",c=function(c,u,p,s,d){function f(){Q.attr("transform","translate("+t.event.translate+")scale("+t.event.scale+")")}function h(t,r){var n=t;a.querySrv({query:n},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){var a=$("div.tree-node-author-info ."+r);if(a.html(""),e){var n=e["@graph"];if(n){var i=n.length?n:[n],o=$("<div>");a.append(o),i=_.sortBy(i,function(t){return t.hasOwnProperty("uc:total")?(console.log(t["uc:total"]["@value"]),parseInt(t["uc:total"]["@value"])):-1}).reverse(),_.map(i,function(t){if(t["rdfs:label"]&&t["uc:total"]["@value"]){var e=$("<a class='relatedauthors' target='blank' onclick = 'return clickonRelatedauthor(\""+t["@id"]+"\")'  >").text("");return e.append(t["rdfs:label"]+"("+t["uc:total"]["@value"]+")"),o.append(e),o.append("</br>"),e}})}waitingDialog.hide()}waitingDialog.hide()})})}function b(t){var e=t.author["@id"],a=_.findWhere(t.author.jsonld["@graph"],{"@id":e,"@type":"foaf:Person"});if(a["foaf:name"]){var r=String.format(o,a["foaf:name"],e);h(r,"authorsByClusters");var r=String.format(l,a["foaf:name"],e);h(r,"authorsByPublications")}}function v(t){I=t;var e=B.scale(),a=-t.y0,r=-t.x0;a=a*e+W/2,r=r*e+F/2,c.select("g").transition().duration(D).attr("transform","translate("+a+","+r+")scale("+e+")"),B.scale(e),B.translate([a,r])}function m(t,n){var i=t.author["@id"],l={"foaf:name":{label:"Nombre:",containerType:"div"},"uc:fullName":{label:"IES: ",containerType:"div"},"uc:city":{label:"Ciudad: ",containerType:"div"},"uc:province":{label:"Provincia: ",containerType:"div"},"dct:subject":{label:"Subjects: ",containerType:"div"}},c=e.PREFIX+" CONSTRUCT   {      <"+i+"> foaf:name ?name;      uc:fullName ?provname;      uc:city ?city;      uc:province ?province;      dct:subject ?subjects  }  WHERE {      GRAPH <"+e.centralGraph+"> {          <"+i+"> foaf:name ?name;          dct:provenance ?provenance;          OPTIONAL {  <"+i+"> dct:subject ?subjects. }         {              SELECT DISTINCT *              WHERE             {                 graph <"+e.endpointsGraph+">                  {                      ?provenance uc:fullName ?provname.                     ?provenance uc:city ?city.                     ?provenance uc:province ?province.                 }             }         }       }   }  ",u=$("div.authorinfo");if(u.html(""),a.querySrv({query:c},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var a=e["@graph"][0];_.each(_.keys(l),function(t,e){if(a[t]){var r=$('<div class="explorableTree pubinfo"  style="background-color: #F7F8E0">'),n=$('<span class="label-author">').text(l[t].label);r.append(n),u.append(r);var i=a[t].length?a[t]:[a[t]];if("string"==typeof i){var o=$('<span class="field-value">').text(i);r.append(o)}else _.map(i,function(t,e){if(e<=5){var a=$('<span class="field-value" style="font-size:70%">').text(t);r.append(a),r.append(", ")}})}}),u.append("<hr>")}})}),n){var i=t.author["@id"],p=_.findWhere(t.author.jsonld["@graph"],{"@id":i,"@type":"foaf:Person"});if(p["foaf:name"]){var s=String.format(o,p["foaf:name"],i);waitingDialog.show("Loading Authors Related with "+p["foaf:name"]),a.querySrv({query:s},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var a=e["@graph"];if(a){a.length?a:[a];d.ifrightClick({value:e})}waitingDialog.hide()}else waitingDialog.hide()})})}}else{var f=$("div.tree-node-info"),i=t.author["@id"],p=_.findWhere(t.author.jsonld["@graph"],{"@id":i,"@type":"foaf:Person"});if(!(p["@id"].indexOf("ucuenca")>0)&&t.author.jsonld["@graph"].length<=1){var h=p["@id"];waitingDialog.show("Searching publications of the external author");var b=e.PREFIX+"CONSTRUCT  { <"+h+"> ?propaut ?obbaut. ?obbaut ?propub ?objpub.    } WHERE{graph <"+e.externalAuthorsGraph+">        {<"+h+"> ?propaut ?obbaut.?obbaut ?propub ?objpub.}      }";a.querySrv({query:b},function(a){jsonld.compact(a,e.CONTEXT,function(a,n){n["@graph"]?(t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],n["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:Document"},e.CONTEXT,X),waitingDialog.hide()):r.query({resource:h},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){if(r["@graph"]){t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],r["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:Document"},e.CONTEXT,X),waitingDialog.hide()}else waitingDialog.hide(),alert("Papers not obtained for external author, you can try again")})})})}),f.append(anchor)}else{var v;if(t.author.jsonld["@graph"].length>1)v=t.author.jsonld,g("publication",t,v,{"@type":"bibo:Document"},e.CONTEXT,X);else{var m=t.author["@id"],y=e.PREFIX+" CONSTRUCT {  <"+m+"> foaf:publications ?pub .  ?pub a bibo:Document .  ?pub dct:title ?title .    ?pub bibo:abstract ?abstract.  ?pub bibo:uri ?uri.  ?pub dct:contributor ?contributor.  ?pub dct:publisher ?publisher.  ?pub bibo:Quote ?keyword.  ?pub dct:isPartOf ?isPartOf.  ?pub bibo:numPages ?numPages.  }  WHERE { graph <"+e.centralGraph+"> {   <"+m+'> foaf:publications ?pub . ?pub dct:title ?title  OPTIONAL {?pub bibo:abstract ?abstract. }  OPTIONAL {?pub bibo:uri ?uri. }  OPTIONAL {?pub dct:contributor ?contributor. }  OPTIONAL {?pub dct:publisher ?publisher. }  OPTIONAL {?pub bibo:Quote ?keyword. }  OPTIONAL {?pub dct:isPartOf ?isPartOf. }  OPTIONAL {?pub bibo:numPages ?numPages. }  FILTER (!regex(?contributor, ":node"))  } } ';a.querySrv({query:y},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],r["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:Document"},e.CONTEXT,X)})})}}}}function g(t,e,a,r,n,i){e.children||(e.children=[]);var o;o="null"===r?a:_.where(a["@graph"],r),o.forEach(function(r){var o={};o[t]={"@id":r["@id"],jsonld:{"@context":n,"@graph":[r],"@id":a["@id"]}},o.children=null,e.children.push(o),i.push(r["@id"])}),w(e,!0),v(e)}function y(t){var r=$("div.tree-node-info");if(r){var o=t.publication["@id"],l=_.findWhere(t.publication.jsonld["@graph"],{"@id":o,"@type":"bibo:Document"}),c={"dct:title":{label:"Titulo",containerType:"div"},"bibo:uri":{label:"URL: Link Externo",containerType:"a"},"dct:contributor":{label:"CO-Autores - Links Externos: ",containerType:"a"},"dct:isPartOf":{label:"Es parte de: ",containerType:"a"},"dct:license":{label:"Licencia: ",containerType:"a"},"dct:provenance":{label:"Fuente: ",containerType:"div"},"dct:publisher":{label:"Publisher: ",containerType:"div"},"bibo:numPages":{label:"Paginas: ",containerType:"div"},"bibo:abstract":{label:"Abstract: ",containerType:"div"},"bibo:Quote":{label:"Keywords: ",containerType:"div"}},u=$("div.try-external-search .external-search-google");u.html("");var p=$("<div>"),s=$("<a target='blank'>").attr("href",String.format(e.urltofindinGOOGLE,l["dct:title"])).text("GOOGLE SCHOLAR");p.append(s),u.append(p);var d=$("div.try-external-search .external-search-dblp");d.html("");var f=$("<div>"),h=$("<a target='blank'>").attr("href",String.format(e.urltofindinDBLP,l["dct:title"])).text("DBLP");f.append(h),d.append(f);var b=$("div.try-external-search .external-search-scopus");b.html("");var v=$("<div>"),m=$("<a target='blank'>").attr("href",String.format(e.urltofindinSCOPUS,l["dct:title"],l["dct:title"],l["dct:title"])).text("SCOPUS");v.append(m),b.append(v);var y=$("div.try-external-search .external-search-academics");y.html("");var x=$("<div>"),T=$("<a target='blank'>").attr("href",String.format(e.urltofindinACADEMICS,l["dct:title"],l["dct:title"])).text("MICROSOFT ACADEMICS");x.append(T),y.append(x),r.find("h4").text("Información del Articulo");var E=$("div.tree-node-info .entityInfo");E.html(""),_.each(_.keys(c),function(t,e){if(l[t])if("a"===c[t].containerType){var a=l[t].length?_.pluck(l[t],"@id"):void 0===l[t]["@id"]?[l[t]]:[l[t]["@id"]],r=$("<div>"),n=$('<span class="label label-primary">').text(c[t].label);r.append(n),r.append("</br>"),E.append(r),_.map(a,function(t){var e=t,a=t.substr(t.lastIndexOf("/")+1);e.indexOf("elsevier")>0&&(e="http://www.scopus.com/authid/detail.uri?authorId="+a);var n=t.substr(t.lastIndexOf("/")+1);n=n.replace("acute=","").replace("=","").replace(":"," "),n=n.replace(","," "),n=n.replace("ntilde=","ñ");var i;return i=$("<a target='blank'>").attr("href",e).text(n),r.append(i),r.append("</br>"),i})}else{var r=$('<div class="explorableTree pubinfo"  style="background-color: #F7F8E0">'),n=$('<span class="label label-primary">').text(c[t].label);r.append(n),r.append("</br>"),E.append(r);var a=l[t].length?l[t]:[l[t]];if("string"==typeof a){var i=$('<span class="field-value">').text(a);r.append(i)}else _.map(a,function(t,e){var a=$('<span class="field-value">').text(t);r.append(a),r.append("</br>")})}}),E.append("<hr>");var j=n.location.origin,O=$("<a target='blank'>").attr("href",j+"/marmottatest/meta/text/html?uri="+l["@id"]).text("Mas Información");E.append(O),E.append("<hr>"),E.append("<h3>Exportar Datos Estructurados</h3>"),O=$("<a target='blank'>").attr("href",j+"/marmottatest/resource?uri="+l["@id"]+"&format=application/rdf%2Bjson").text("RDF+XML"),E.append("<br>"),E.append(O),O=$("<a target='blank'>").attr("href",j+"/marmottatest/resource?uri="+l["@id"]+"&format=text/turtle").text("Turtle"),E.append("<br>"),E.append(O),O=$("<a target='blank'>").attr("href",j+"/marmottatest/resource?uri="+l["@id"]+"&format=application/ld%2Bjson").text("JSON-LD"),E.append("<br>"),E.append(O)}var c;if(t.publication.jsonld["@graph"].length>1)c=t.publication.jsonld,g("author",t,c,{"@type":"foaf:Person"},e.CONTEXT,L);else{var P=(t.publication["@id"],[]),C=[],R=t.publication.jsonld["@graph"][0]["dct:contributor"];_.map(R,function(t){var r=e.PREFIX+" Construct { <"+t["@id"]+"> foaf:name ?name } WHERE { \t<"+t["@id"]+'> <http://www.elsevier.com/xml/svapi/rdf/dtd/givenName> ?externalfname; <http://www.elsevier.com/xml/svapi/rdf/dtd/surname> ?externallname.   BIND (CONCAT(?externallname,", ", ?externalfname) as ?name) }';a.querySrv({query:r},function(a){jsonld.compact(a,e.CONTEXT,function(e,a){if(a["@graph"]&&a["@graph"][0]["foaf:name"]){var r=a["@graph"][0]["foaf:name"];r=r.replace("acute=","").replace("=","").replace(":"," "),r=r.replace(","," "),r=r.replace(","," "),r=r.replace("ntilde=","ñ"),P.push({"@id":t["@id"],"@type":"foaf:Person","foaf:name":r})}else{var r=t["@id"].substr(t["@id"].lastIndexOf("/")+1);r=r.replace("acute=","").replace("=","").replace(":"," "),r=r.replace(","," "),r=r.replace("ntilde=","ñ"),i(r)||P.push({"@id":t["@id"],"@type":"foaf:Person","foaf:name":r})}})})});var w=e.PREFIX+" CONSTRUCT {  <"+t.publication["@id"]+"> dct:contributors ?subject.  ?subject foaf:name ?name.  ?subject a foaf:Person.  }  WHERE {  GRAPH <"+e.centralGraph+">  {  ?subject foaf:publications  <"+t.publication["@id"]+">.  ?subject foaf:name ?name.  FILTER( <"+t.parent.author["@id"]+"> != ?subject) }}";a.querySrv({query:w},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){if(r){var n=_.where(r["@graph"],{"@type":"foaf:Person"});_.map(n,function(t){var e=t["foaf:name"];e=e.replace(","," "),C.push({"@id":t["@id"],"@type":"foaf:Person","foaf:name":e})})}_.map(P,function(t){if(t["foaf:name"]){var e=t["foaf:name"].toString();e=e.replace(","," ");var a=_.findWhere(C,{"foaf:name":e}),r=!1;_.map(C,function(t){levenshtein_distance(e,t["foaf:name"])<12&&(r=!0)}),a||r||C.push(t)}else C.push(t)});var i={"@graph":C};g("author",t,i,"foaf:Person",e.CONTEXT,L)})})}}function x(t){var e=t["@graph"][0]["@id"];return L.push(e),{author:{"@id":e,jsonld:t},children:null}}function T(t){return"author"in t}function E(t){return"publication"in t}function j(t){if(t.children&&t.children.forEach(function(t){j(t)}),T(t)){var e=L.indexOf(t.author.id);L.splice(e,1)}}function O(t){t.children.forEach(function(t){j(t)})}function P(t){return T(t)&&m(t,!0),t}function C(t){if(t.children){var e=$("div.tree-node-info .entityInfo");e.html("");var a=$("div.try-external-search .external-search-google");a.html("");var r=$("div.try-external-search .external-search-dblp");r.html("");var n=$("div.try-external-search .external-search-scopus");n.html(""),O(t),t.children=null,w(t,!1),v(t)}else T(t)?m(t,!1):E(t)&&y(t);return t}function R(t){t=C(t)}function w(e,a){var r=[1],n=function(t,e){e.children&&e.children.length>0&&(r.length<=t+1&&r.push(0),r[t+1]+=e.children.length,e.children.forEach(function(e){n(t+1,e)}))};n(0,S);var i=110*t.max(r);q=q.size([i,W]);var o=q.nodes(S).reverse(),l=q.links(o);o.forEach(function(t){t.y=220*t.depth});var c=Q.selectAll("g.tree-node").data(o,function(t){return t.id||(t.id=++A)}),u=t.tip().attr("class","tree-d3-tip").html(function(t){return" "}),p=c.enter().append("g").call(a?u:function(){}).attr("class","tree-node").attr("transform",function(t){return"translate("+e.y0+","+e.x0+")"}).on("mouseover",function(t){var e=t;if("publication"in t){var a=t.publication["@id"],r=_.findWhere(e.publication.jsonld["@graph"],{"@id":a,"@type":"bibo:Document"})["dct:title"];u.html(r),u.show(t)}}).on("mouseout",function(t){"publication"in t&&u.hide(t),"author"in t&&u.hide(t)}).on("contextmenu",t.contextMenu(U,function(t){console.log("Quick! Before the menu appears!"),"author"in t||window.stop()})).on("click",R);p.append("circle").attr("r",32).style("fill",function(t){return t._children?"black":"#fff"}),G++,p.append("clipPath").attr("id","clipCircle"+G).append("circle").attr("r",32),p.append("image").attr("xlink:href",function(t){return T(t)?t.author.jsonld["@graph"][0]["foaf:name"]&&t.author.jsonld["@graph"][0]["@id"].indexOf("ucuenca")>0?"wkhome/images/author-ec.png":"wkhome/images/author-default.png":"wkhome/images/document-default.png"}).attr("x","-32px").attr("y","-32px").attr("clip-path","url(#clipCircle"+G+")").attr("width",function(t){return 64}).attr("height",function(t){return 64}),p.append("text").attr("x",function(t){return-125}).attr("dy","40").attr("class","tree-nodeText").attr("text-anchor",function(t){return"start"}).text(function(t){if(T(t)){var e=t.author["@id"],a=_.findWhere(t.author.jsonld["@graph"],{"@id":e,"@type":"foaf:Person"});return a["foaf:name"]}}).style("fill-opacity",0);var s=c.transition().duration(D).attr("transform",function(t){return"translate("+t.y+","+t.x+")"});s.select("text").style("fill-opacity",1);var d=c.exit().transition().duration(D).attr("transform",function(t){return"translate("+e.y+","+e.x+")"}).remove();d.select("circle").attr("r",0),d.select("text").style("fill-opacity",0);var f=Q.selectAll("path.tree-link").data(l,function(t){return t.target.id});f.enter().insert("path","g").attr("class","tree-link").attr("d",function(t){var a={x:e.x0,y:e.y0};return H({source:a,target:a})}),f.transition().duration(D).attr("d",H),f.exit().transition().duration(D).attr("d",function(t){var a={x:e.x,y:e.y};return H({source:a,target:a})}).remove(),o.forEach(function(t){t.x0=t.x,t.y0=t.y})}var N=c;N.html("");var k,S,I,A=0,D=750,L=[],X=[],G=0,W=u,F=p,q=t.layout.tree().size([p,u]),H=t.svg.diagonal().projection(function(t){return[t.y,t.x]}),B=t.behavior.zoom().scaleExtent([.1,3]).on("zoom",f);c.attr("width",W).attr("height",F).attr("class","tree-overlay").call(B);var U=[{title:"Autores Relacionados",action:function(t,e,a){P(e)}}],Q=c.append("g");L=[],S=x(s),S.x0=F/2,S.y0=0,k=S.author["@id"],b(S),w(S,!0),v(S),R(S)};return{restrict:"E",scope:{data:"=",ifrightClick:"&",clickonRelatedAuthor:"&"},compile:function(e,a,r){var n=$(e).width(),i=$(e).height(),o=t.select(e[0]).append("svg");return function(t,e,a){t.$watch("data",function(t,e,a){if(a.data&&JSON.stringify(t["@graph"])!=JSON.stringify(e?e["@graph"]:e)){var r=jQuery.extend({},a.data);c(o,n,i,r,a)}},!0)}}}}]);