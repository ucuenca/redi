"use strict";var explorableTree=angular.module("explorableTree",[]);explorableTree.factory("d3",function(){return d3}),explorableTree.directive("explorableTree",["d3","globalData","sparqlQuery","authorRestQuery","$window",function(t,e,a,r,i){var o=e.PREFIX+'CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle. <http://ucuenca.edu.ec/wkhuska/resultTitle> uc:viewtitle "Authors Related With {0}". ?subject rdfs:label ?name.?subject uc:total ?totalPub } WHERE {  {    SELECT ?subject ?name (COUNT(DISTINCT ?relpublication) as ?totalPub)    WHERE {        GRAPH <'+e.clustersGraph+"> {          ?cluster foaf:publications ?publication .          ?publication uc:hasPerson <{1}> .          ?cluster foaf:publications ?relpublication .          ?relpublication uc:hasPerson ?subject .          {            SELECT ?name {              GRAPH <"+e.centralGraph+"> {                 ?subject foaf:name ?name .              }            }          }          FILTER (?subject != <{1}>)        }    }    GROUP BY ?subject ?name  }}",n=e.PREFIX+'CONSTRUCT {  <http://ucuenca.edu.ec/wkhuska/resultTitle> a uc:pagetitle;                                              uc:viewtitle "Authors Related With {0}".  ?subject rdfs:label ?name.  ?subject uc:total ?totalPub .  ?subject foaf:img ?img .} WHERE  {  SELECT ?subject ?name (COUNT(?pub) as ?totalPub) ?img  WHERE { GRAPH <'+e.centralGraph+"> {    <{1}> foaf:publications ?pub.    ?subject foaf:publications ?pub;             foaf:name ?name.     OPTIONAL{?subject  foaf:img ?img.}    FILTER(<{1}> != ?subject)  }} GROUP BY ?subject ?name ?img}",c=function(i,c,l,u,s){function f(){F.attr("transform","translate("+t.event.translate+")scale("+t.event.scale+")")}function d(t,r){a.querySrv({query:t},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){var a=$("div.tree-node-author-info ."+r);if(a.html(""),e){var i=e["@graph"];if(i){var o=i.length?i:[i],n=$("<div>");a.append(n),o=_.sortBy(o,function(t){return t.hasOwnProperty("uc:total")?parseInt(t["uc:total"]["@value"]):-1}).reverse(),o=_.first(o,20),_.map(o,function(t){if(t["rdfs:label"]&&t["uc:total"]["@value"]){var e="string"==typeof t["rdfs:label"]?t["rdfs:label"]:_.first(t["rdfs:label"],1),a=$("<a class='relatedauthors' target='blank' onclick = 'return clickonRelatedauthor(\""+t["@id"]+"\")'  >").text(""),r=t["foaf:img"]?t["foaf:img"]["@id"]:"/wkhome/images/author-ec.png";return a.append('<img src="'+r+'" class="img-rounded" alt="Logo Cedia" width="20" height="20"        >'),a.append(e+"("+t["uc:total"]["@value"]+")"),n.append(a),n.append("</br>"),a}})}waitingDialog.hide()}waitingDialog.hide()})})}function p(t){var e=t.author["@id"],a=_.findWhere(t.author.jsonld["@graph"],{"@id":e,"@type":"foaf:Person"});if(a["foaf:name"]){var r=String.format(o,a["foaf:name"],e);d(r,"authorsByClusters");var i=String.format(n,a["foaf:name"],e);d(i,"authorsByPublications")}}function h(t){A=t;var e=q.scale(),a=-t.y0,r=-t.x0;a=a*e+W/2,r=r*e+X/2,i.select("g").transition().duration(k).attr("transform","translate("+a+","+r+")scale("+e+")"),q.scale(e),q.translate([a,r])}function b(t,i){var n=t.author["@id"],c={"foaf:name":{label:"Nombre:",containerType:"div"},"uc:fullName":{label:"Instituci√≥n: ",containerType:"div"},"uc:city":{label:"Ciudad: ",containerType:"div"},"uc:province":{label:"Provincia: ",containerType:"div"},"dct:subject":{label:"Subjects: ",containerType:"div"}},l=e.PREFIX+" CONSTRUCT   {      <"+n+"> foaf:name ?name;      uc:fullName ?provname;      uc:city ?city;      uc:province ?province;      dct:subject ?subjects  }  WHERE {      GRAPH <"+e.centralGraph+"> {          <"+n+"> foaf:name ?name;          dct:provenance ?provenance;          OPTIONAL {  <"+n+"> foaf:topic_interest [rdfs:label ?subjects]. }         {              SELECT DISTINCT ?provenance ?city ?provname ?province              WHERE             {                 graph <"+e.endpointsGraph+">                  {                      ?provenance uc:fullName ?provname.                     ?provenance uc:city ?city.                     ?provenance uc:province ?province.                 }             }         }       }   }  ",u=$("div.authorinfo");if(u.html(""),a.querySrv({query:l},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e["@graph"]){var a=e["@graph"][0];_.each(_.keys(c),function(t,e){if(a[t]){var r=$('<div class="explorableTree pubinfo"  style="background-color: #F7F8E0">'),i=$('<span class="label-author">').text(c[t].label);r.append(i),u.append(r);var o=a[t].length?a[t]:[a[t]];if("foaf:name"===t&&(o="string"==typeof o?o:_.first(o)),location.href.indexOf("/es/")!==-1&&"uc:fullName"===t?o=_.findWhere(a["uc:fullName"],{"@language":"es"})["@value"]:location.href.indexOf("/en/")!==-1&&"uc:fullName"===t&&(o=_.findWhere(a["uc:fullName"],{"@language":"en"})["@value"]),"string"==typeof o){var n=$('<span class="field-value">').text(o);r.append(n)}else _.map(o,function(t,e){if(e<=5){var a=$('<span class="field-value" style="font-size:70%">').text(t);r.append(a),r.append(", ")}})}}),u.append("<hr>")}})}),i){var n=t.author["@id"],f=_.findWhere(t.author.jsonld["@graph"],{"@id":n,"@type":"foaf:Person"});if(f["foaf:name"]){var d=String.format(o,f["foaf:name"],n);waitingDialog.show("Loading Authors Related with "+f["foaf:name"]),a.querySrv({query:d},function(t){jsonld.compact(t,e.CONTEXT,function(t,e){if(e){var a=e["@graph"];if(a){a.length?a:[a];s.ifrightClick({value:e})}waitingDialog.hide()}else waitingDialog.hide()})})}}else{var p=$("div.tree-node-info"),n=t.author["@id"],f=_.findWhere(t.author.jsonld["@graph"],{"@id":n,"@type":"foaf:Person"});if(!(f["@id"].indexOf("localhost")>0)&&t.author.jsonld["@graph"].length<=1){var h=f["@id"];waitingDialog.show("Searching publications of the external author");var b=e.PREFIX+"CONSTRUCT  { <"+h+"> ?propaut ?obbaut. ?obbaut ?propub ?objpub.    } WHERE{graph <"+e.externalAuthorsGraph+">        {<"+h+"> ?propaut ?obbaut.?obbaut ?propub ?objpub.}}";a.querySrv({query:b},function(a){jsonld.compact(a,e.CONTEXT,function(a,i){i["@graph"]?(t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],i["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:AcademicArticle"},e.CONTEXT,L),waitingDialog.hide()):r.query({resource:h},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){if(r["@graph"]){t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],r["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:AcademicArticle"},e.CONTEXT,L),waitingDialog.hide()}else waitingDialog.hide(),alert("Papers not obtained for external author, you can try again")})})})}),p.append(anchor)}else{var m;if(t.author.jsonld["@graph"].length>1)m=t.author.jsonld,g("publication",t,m,{"@type":"bibo:AcademicArticle"},e.CONTEXT,L);else{var v=t.author["@id"],y=e.PREFIX+"CONSTRUCT {  <"+v+"> foaf:publications ?pub .  ?pub a bibo:AcademicArticle ;           dct:title ?title;}WHERE { GRAPH <"+e.centralGraph+"> {   <"+v+"> foaf:publications ?pub .  ?pub dct:title ?title.}}";a.querySrv({query:y},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){t.author.jsonld["@context"]=_.extend(t.author.jsonld["@context"],e.CONTEXT),t.author.jsonld["@graph"]=_.flatten([t.author.jsonld["@graph"],r["@graph"]]),g("publication",t,t.author.jsonld,{"@type":"bibo:AcademicArticle"},e.CONTEXT,L)})})}}}}function g(t,e,a,r,i,o){e.children||(e.children=[]);var n;n="null"===r?a:_.where(a["@graph"],r),n.forEach(function(r){var n={};n[t]={"@id":r["@id"],jsonld:{"@context":i,"@graph":[r],"@id":a["@id"]}},n.children=null,e.children.push(n),o.push(r["@id"])}),E(e,!_.isEmpty(n)),h(e)}function m(t){var r=t.publication["@id"];if(r){var i=e.PREFIX+"CONSTRUCT {  <"+r+"> a bibo:AcademicArticle ;\t\t\t\t\t\t\t\tdct:title ?title; \t\t\t\t\t\t\t\tbibo:abstract ?abstract; \t\t\t\t\t\t\t\tbibo:uri ?uri; \t\t\t\t\t\t\t\tbibo:doi ?doi; \t\t\t\t\t\t\t\tbibo:pages ?pages; \t\t\t\t\t\t\t\tbibo:created ?created; \t\t\t\t\t\t\t\tbibo:issue ?issue; \t\t\t\t\t\t\t\tbibo:volume ?volumne; \t\t\t\t\t\t\t\tdct:contributor ?contributorURI; \t\t\t\t\t\t\t\tdct:creator ?creatorURI; \t\t\t\t\t\t\t\tdct:publisher ?publisher; \t\t\t\t\t\t\t\tdct:subject ?keyword; \t\t\t\t\t\t\t\tdct:isPartOf ?isPartOfURI.  ?contributorURI foaf:name ?contributor. ?contributorURI foaf:img ?imgContributor. ?creatorURI foaf:name ?creator. ?creatorURI foaf:img ?imgCreator. ?isPartOfURI rdfs:label ?isPartOf. } WHERE { GRAPH <http://ucuenca.edu.ec/wkhuska> {   <"+r+"> dct:title ?title.  OPTIONAL {<"+r+"> bibo:abstract ?abstract. }  OPTIONAL {<"+r+"> bibo:uri ?uri. }  OPTIONAL {<"+r+"> bibo:doi ?doi. }  OPTIONAL {<"+r+"> bibo:pages ?pages. }  OPTIONAL {<"+r+"> bibo:created ?created. }  OPTIONAL {<"+r+"> bibo:issue ?issue. }  OPTIONAL {<"+r+"> bibo:volume ?volumne. }  OPTIONAL {<"+r+"> dct:contributor ?contributorURI. }  OPTIONAL {?contributorURI foaf:name ?contributor. }  OPTIONAL {?contributorURI foaf:img ?imgContributor. }  OPTIONAL {<"+r+"> dct:creator ?creatorURI. }  OPTIONAL {?creatorURI foaf:name ?creator.}  OPTIONAL {?creatorURI foaf:img ?imgCreator.}  OPTIONAL {<"+r+"> dct:publisher ?publisherURI.}  OPTIONAL {?publisherURI rdfs:label ?publisher. }  OPTIONAL {<"+r+"> dct:subject ?keywordURI. }  OPTIONAL {?keywordURI rdfs:label ?keyword}  OPTIONAL {<"+r+"> dct:isPartOf ?isPartOfURI. }  OPTIONAL {?isPartOfURI rdfs:label ?isPartOf}}}";a.querySrv({query:i},function(a){jsonld.compact(a,e.CONTEXT,function(a,r){var i=[],o={},n=_.findWhere(r["@graph"],{"@type":"bibo:AcademicArticle"}),c=location.protocol+"//"+location.host+location.pathname+"resource?uri="+n["@id"]+"&format={0}",l=[{url:String.format(c,"application/rdf%2Bjson"),label:"RDF/JSON",img:"/wkhome/images/rdf-json.png"},{url:String.format(c,"application/rdf%2Bxml"),label:"RDF/XML",img:"/wkhome/images/rdf-xml.png"},{url:String.format(c,"text/turtle"),label:"Turtle",img:"/wkhome/images/turtle.png"},{url:String.format(c,"text/rdf%2Bn3"),label:"N3",img:"/wkhome/images/n3.png"},{url:String.format(c,"application/ld%2Bjson"),label:"JSON-LD",img:"/wkhome/images/json-ld.png"}],u=function(t){return"string"==typeof t?t:_.first(t)},f=function(t){var e="string"==typeof t?_.findWhere(r["@graph"],{"@id":t}):_.findWhere(r["@graph"],t),a={};a["@id"]=e["@id"],a["foaf:name"]=u(e["foaf:name"]),a["@type"]="foaf:Person",a["foaf:img"]=e["foaf:img"]?e["foaf:img"]:void 0,i.push(a)},d=function(t,e){var a;if("string"==typeof t)a=t,t={"@id":a};else{if("object"!=typeof t)return;a=t["@id"]}return a.indexOf("scholar.google.com")!==-1?(t.source="scholar",t.label="Google Scholar",t.img="/wkhome/images/scholar.png"):a.indexOf("academic.microsoft.com")!==-1?(t.source="academics",t.label="Academics Knowledge",t.img="/wkhome/images/academics.png"):a.indexOf("dblp.com")!==-1?(t.source="dblp",t.label="DBLP",t.img="/wkhome/images/dblp.png"):a.indexOf("scopus.com")!==-1?(t.source="scopus",t.label="Scopus",t.img="/wkhome/images/scopus.png"):a.indexOf("researchgate.net")!==-1?(t.source="research-gate",t.label="Research Gate",t.img="/wkhome/images/researchgate.png"):a.indexOf("springer.com")!==-1?(t.source="springer",t.label="Springer",t.img="/wkhome/images/springer.png"):a.indexOf("pdf")!==-1?(t.source="pdf",t.label="PDF source",t.img="/wkhome/images/pdf.png"):(t.source="web",t.label="Web source",t.img="/wkhome/images/world.png"),t};o.id=n["@id"],o.title=u(n["dct:title"]),o["abstract"]=u(n["bibo:abstract"]),o.doi=u(n["bibo:doi"]),o.pages=u(n["bibo:pages"]),o.created=u(n["bibo:created"]),o.issue=u(n["bibo:issue"]),o.volume=u(n["bibo:volume"]),o.publisher=u(n["dct:publisher"]),o.uri=_.mapObject(n["bibo:uri"],d),o.subjects=n["dct:subject"],_.each(n["dct:contributor"],f),_.each(n["dct:creator"],f),o.authors=_.uniq(i,function(t){return t["@id"]}),o.formats=l,s.publication=o,s.$apply(),g("author",t,{"@graph":_.without(o.authors,_.findWhere(i,{"@id":t.parent.author["@id"]}))},"foaf:Person",e.CONTEXT,S)})})}}function v(t){var e=t["@graph"][0]["@id"];return S.push(e),{author:{"@id":e,jsonld:t},children:null}}function y(t){return"author"in t}function O(t){return"publication"in t}function T(t){if(t.children&&t.children.forEach(function(t){T(t)}),y(t)){var e=S.indexOf(t.author.id);S.splice(e,1)}}function x(t){t.children.forEach(function(t){T(t)})}function j(t){return y(t)&&b(t,!0),t}function P(t){if(t.children){var e=$("div.tree-node-info .entityInfo");e.html("");var a=$("div.try-external-search .external-search-google");a.html("");var r=$("div.try-external-search .external-search-dblp");r.html("");var i=$("div.try-external-search .external-search-scopus");i.html(""),x(t),t.children=null,E(t,!1),h(t)}else y(t)?b(t,!1):O(t)&&m(t);return t}function R(t){t=P(t)}function E(e,a){var r=[1],i=function(t,e){e.children&&e.children.length>0&&(r.length<=t+1&&r.push(0),r[t+1]+=e.children.length,e.children.forEach(function(e){i(t+1,e)}))};i(0,w);var o=110*t.max(r);D=D.size([o,W]);var n=D.nodes(w).reverse(),c=D.links(n);n.forEach(function(t){t.y=220*t.depth});var l=F.selectAll("g.tree-node").data(n,function(t){return t.id||(t.id=++C)}),u=t.tip().attr("class","tree-d3-tip").html(function(t){return" "}),s=l.enter().append("g").call(a?u:function(){}).attr("class","tree-node").attr("transform",function(t){return"translate("+e.y0+","+e.x0+")"}).on("mouseover",function(t){var e=t;if("publication"in t){var a=t.publication["@id"],r=_.findWhere(e.publication.jsonld["@graph"],{"@id":a,"@type":"bibo:AcademicArticle"})["dct:title"];"string"!=typeof r&&(r=_.first(r)),u.html(r),u.show(t)}}).on("mouseout",function(t){"publication"in t&&u.hide(t),"author"in t&&u.hide(t)}).on("contextmenu",t.contextMenu(H,function(t){console.log("Quick! Before the menu appears!"),"author"in t||window.stop()})).on("click",R);s.append("circle").attr("r",32).style("fill",function(t){return t._children?"black":"#fff"}),U++,s.append("clipPath").attr("id","clipCircle"+U).append("circle").attr("r",32),s.append("image").attr("xlink:href",function(t){return y(t)?t.author.jsonld["@graph"][0]["foaf:name"]&&t.author.jsonld["@graph"][0]["foaf:img"]?t.author.jsonld["@graph"][0]["foaf:img"]["@id"]:t.author.jsonld["@graph"][0]["foaf:name"]&&t.author.jsonld["@graph"][0]["@id"].indexOf("localhost")>0?"wkhome/images/author-ec.png":"wkhome/images/author-default.png":"wkhome/images/document-default.png"}).attr("x","-32px").attr("y","-32px").attr("clip-path","url(#clipCircle"+U+")").attr("width",function(t){return 64}).attr("height",function(t){return 64}),s.append("text").attr("x",function(t){return-125}).attr("dy","40").attr("class","tree-nodeText").attr("text-anchor",function(t){return"start"}).text(function(t){if(y(t)){var e=t.author["@id"],a=_.findWhere(t.author.jsonld["@graph"],{"@id":e,"@type":"foaf:Person"}),r="string"==typeof a["foaf:name"]?a["foaf:name"]:_.first(a["foaf:name"]);return r}}).style("fill-opacity",0);var f=l.transition().duration(k).attr("transform",function(t){return"translate("+t.y+","+t.x+")"});f.select("text").style("fill-opacity",1);var d=l.exit().transition().duration(k).attr("transform",function(t){return"translate("+e.y+","+e.x+")"}).remove();d.select("circle").attr("r",0),d.select("text").style("fill-opacity",0);var p=F.selectAll("path.tree-link").data(c,function(t){return t.target.id});p.enter().insert("path","g").attr("class","tree-link").attr("d",function(t){var a={x:e.x0,y:e.y0};return G({source:a,target:a})}),p.transition().duration(k).attr("d",G),p.exit().transition().duration(k).attr("d",function(t){var a={x:e.x,y:e.y};return G({source:a,target:a})}).remove(),n.forEach(function(t){t.x0=t.x,t.y0=t.y})}var N=i;N.html("");var I,w,A,C=0,k=750,S=[],L=[],U=0,W=c,X=l,D=t.layout.tree().size([l,c]),G=t.svg.diagonal().projection(function(t){return[t.y,t.x]}),q=t.behavior.zoom().scaleExtent([.1,3]).on("zoom",f);i.attr("width",W).attr("height",X).attr("class","tree-overlay").call(q);var H=[{title:"Autores Relacionados",action:function(t,e,a){j(e)}}],F=i.append("g");S=[],w=v(u),w.x0=X/2,w.y0=0,I=w.author["@id"],p(w),E(w,!0),h(w),R(w)};return{restrict:"E",scope:{data:"=",publication:"=",ifrightClick:"&",clickonRelatedAuthor:"&"},compile:function(e,a,r){var i=$(e).width(),o=$(e).height(),n=t.select(e[0]).append("svg");return function(t,e,a){t.$watch("data",function(t,e,a){if(a.data){var r=jQuery.extend({},a.data);c(n,i,o,r,a)}},!0)}}}}]);